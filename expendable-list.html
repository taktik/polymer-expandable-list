<script type="module" src="../@polymer/polymer/polymer-legacy.js"></script>
<script type="module" src="../@polymer/iron-selector/iron-selector.js"></script>
<script type="module" src="../@polymer/paper-styles/shadow.js"></script>
<link rel="import" href="expendable-list-style.html" />

<dom-module id="expendable-list">
  <style include="expendable-list-style"></style>

  <template>
    <iron-selector
      id="selector"
      on-iron-select="_onIronSelect"
      on-iron-deselect="_onIronDeselect"
      attr-for-selected="[[attrForSelected]]"
      multi="{{multi}}"
      selected="{{selected}}"
      selected-values="{{selectedValues}}"
    >
      <content></content>
    </iron-selector>
  </template>

  <script type="module">
    import { PolymerElement } from "@polymer/polymer";
    import "../@polymer/iron-selector/iron-selector.js";
    import "../@polymer/paper-styles/shadow.js";

    class ExpendableList extends PolymerElement {
      static get is() {
        return "expendable-list";
      }
      static get properties() {
        return {
          attrForSelected: String,
          selected: {
            type: String,
            notify: true,
          },
          selectedValues: {
            type: Array,
            notify: true,
          },
          noClose: {
            type: Boolean,
            value: false,
          },
          multi: {
            type: Boolean,
            value: false,
          },
        };
      }

      _onIronSelect(event) {
        const inboxItem = this._getInboxItem(event.detail.item);
        if (inboxItem) {
          inboxItem.open(true);
        }
      }

      _onIronDeselect(event) {
        const inboxItem = this._getInboxItem(event.detail.item);
        if (inboxItem) {
          inboxItem.open(false);
        }
      }

      _getInboxItem(node) {
        if (node.nodeName.toLowerCase() === "expendable-list-item") {
          /* We clicked on an expendable-list-item element */
          return node;
        } else if (node.$$ && node.$$("expendable-list-item")) {
          /* We clicked on a polymer element that may contain an expendable-list-item */
          return node.$$("expendable-list-item")[0];
        } else {
          /* We clicked on a standard HTML container that may contain an expendable-list-item */
          return node.querySelector("expendable-list-item");
        }
      }

      select(id) {
        this.$.selector.select(id);
      }

      ready() {
        const elem = this;
        if (!this.noClose) {
          document.addEventListener("tap", function (event) {
            /* Callback to close the list if we clicked outside of it */
            if (elem.$.selector.selected !== null) {
              const node = event.target;
              while (node) {
                if (node === elem) {
                  return;
                }
                node = node.parentNode;
              }
              elem.$.selector.select(null);
            }
          });
        }
      }
    }

    customElements.define("expendable-list", ExpendableList);
  </script>
</dom-module>
