<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<dom-module id="expendable-list">
    <template>
        <style>
            :host {
                display: block;
            }

            :host ::slotted(expendable-list-item.iron-selected)  {
                width: 100%;
                margin: 15px auto 15px auto;
                @apply --shadow-elevation-16dp;
            }

        </style>

        <iron-selector
                id="selector"
                on-iron-select="_onIronSelect"
                on-iron-deselect="_onIronDeselect"
                attr-for-selected="[[attrForSelected]]"
                multi="{{multi}}"
                selected="{{selected}}"
                selected-values="{{selectedValues}}">
            <slot></slot>
        </iron-selector>

    </template>

    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'expendable-list',

                properties: {
                    attrForSelected: String,
                    selected: {
                        type: String,
                        notify: true
                    },
                    selectedValues: {
                        type: Array,
                        notify: true
                    },
                    noClose: {
                        type: Boolean,
                        value: false
                    },
                    multi: {
                        type: Boolean,
                        value: false
                    }
                },

                _onIronSelect: function(event) {
					event.stopPropagation()
                    var inboxItem = this._getInboxItem(event.detail.item);
                    if (inboxItem) {
                        inboxItem.open(true);
                    }
                },

                _onIronDeselect: function(event) {
					event.stopPropagation()
                    var inboxItem = this._getInboxItem(event.detail.item);
                    if (inboxItem) {
                        inboxItem.open(false);
                    }
                },

                _getInboxItem: function(node) {
					//console.log(node)
                    if (node.nodeName.toLowerCase() === 'expendable-list-item') {
                        /* We clicked on an expendable-list-item element */
                        return node;
                    } else if (node.$$ && node.$$('expendable-list-item')) {
                        /* We clicked on a polymer element that may contain an expendable-list-item */
                        return node.$$('expendable-list-item')[0];
                    } else {
                        /* We clicked on a standard HTML container that may contain an expendable-list-item */
                        return node.querySelector('expendable-list-item');
                    }
                },

                select: function(id) {
                    this.$.selector.select(id);
                },

                ready: function() {
                    var elem = this;
                    if (!this.noClose) {
                        document.addEventListener('tap', function(event) {
							const evenPath = event.getComposedPath()
                            /* Callback to close the list if we clicked outside of it */
                            if (elem.$.selector.selected !== null && !elem.contains(evenPath[0])) {
                                var node = event.target;
                                while (node) {
                                    if (node === elem) {
                                        return;
                                    }
                                    node = node.parentNode;
                                }
                                elem.$.selector.select(null);
                            }
                        });
                    }
                }

            });
        })();
    </script>
</dom-module>
